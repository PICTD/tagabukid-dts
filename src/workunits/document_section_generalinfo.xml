<workunit>
    <invokers>
        <invoker type="dts:section" caption="General Info" action="init" index="-100" />
        
        <invoker type="extActions" caption="Open Child" action="showChild" visibleWhen="#{selectedItem!=null}"/>

    </invokers>
    
    <code>
        <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import java.rmi.server.*
        import tagabukid.utils.*;
        
        class  DocumentGeneralInfoController  {
            @Binding
            def binding;

            @Service("TagbukidDTSService")
            def svc;
            
            String title = "General Info";
            String entityName = "dts:generalinfo";
            
            def entity;
            def attachmentSelectedItem;
            def selectedItem;
            
            def attachmentListHandler = [
                fetchList : { return entity.attachments },
            ] as BasicListModel
            
            void init(){
                loadAttachments()
                listHandler?.load();
            }
            void loadAttachments(){
                entity.attachments = [];
                
                try{
                    entity.attachments = TagabukidDBImageUtil.getInstance().getImages(entity?.objid);
                }
                catch(e){
                    println 'Load Attachment error ============';
                    e.printStackTrace();
                }
                attachmentListHandler?.load();
            }
            
            def addAttachment(){
                return InvokerUtil.lookupOpener('upload:attachment', [
                        entity : entity,
                        afterupload: {
                           loadAttachments();
                        }
                    ]);
            }

            def viewAttachment(){
                if (!attachmentSelectedItem) return null;

                if (attachmentSelectedItem.extension.contains("pdf")){
                   return InvokerUtil.lookupOpener('attachmentpdf:view', [
                        entity : attachmentSelectedItem,
                    ]); 
                }else{
                    return InvokerUtil.lookupOpener('attachment:view', [
                        entity : attachmentSelectedItem,
                    ]); 
                }

            }
            def listHandler = [
                fetchList : { return entity.child },
            ] as EditorListModel
            
            def print() {
                def op = Inv.lookupOpener( "dts:din", [entity: entity] );
                op.target = 'self';
                return op;
            }

            def showChild() {
                if( !selectedItem.objid )
                    throw new Exception("No parent document");
                def child = [:]
                child.objid = selectedItem.objid   
                return Inv.lookupOpener( "dts:open", [entity: child] ); 
            }
            
            
        }
        ]]>
    </code>

    
    <pages>
        <page  template="tagabukid.dts.view.DocumentGeneralInfo"/>
    </pages>
    
</workunit>