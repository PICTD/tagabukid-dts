<workunit>
    <invokers>
        
<!--        <invoker type="business_application:formActions" caption="Business Info" action="openFromApp" visibleWhen="#{entity!=null}"
            index="100" target="popup"/>-->
        
        <invoker type="dts:open" caption="Document Info" action="open" index="100" target="window"/>
        
        <invoker type="global:barcode:71007" caption="Document Tracking System" action="open" target="window"
            expr="#{!barcodeid.contains('-')}"/>
        
        <invoker type="formActions" caption="Close" action="_close" />
        <!--<invoker type="formActions" caption="Edit" action="showEditMenu" icon="images/toolbars/edit.png"/>--> 
        <invoker type="formActions" caption="View Parent" action="showParent" immediate="true" visibleWhen="#{entity.parentid!=null}"/> 
        <!--<invoker type="formActions" caption="Send SMS" action="createSMS" immediate="true" />--> 
    </invokers>
    
    
    <code>
    <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import com.rameses.common.*;
        import java.rmi.server.*
        import com.rameses.util.*;
        import com.rameses.gov.etracs.bpls.business.*;

        class  DocumentInfoController {

            @Service("TagabukidDTSService")
            def service;

            @FormId
            def formId

            @FormTitle
            def title

            @Binding
            def binding;

            def entityName = "documentinfo";
            def entity;

            def sections;
            def currentSection;
            def barcodeid;
            def startstep;

            def openByBIN() {
                MsgBox.alert( 'open business by BIN '+barcodeid ); 
            }
            
            void open() {
                entity = service.open( [objid: entity?.objid,barcodeid: barcodeid,taskid:entity?.taskid ] );
                title = entity.title + ' (' + entity.din + ')';
                loadSections();
                formId = entity.objid;
            }

            void reloadSection() {
               binding.refresh("subform");
            }

            void loadSections() {
                sections = InvokerUtil.lookupOpeners( "dts:section", [entity: entity ] ).findAll {
                    def vw = it.properties.visibleWhen;
                    return  ((!vw)  ||  ExpressionResolver.getInstance().evalBoolean( vw, [entity:entity] ));
                }
                if( sections.size()>0 ) {
                    currentSection = sections[0];
                }  
            }

            void reloadCurrentSection() {
                MsgBox.alert( currentSection.name );
            }
                
            def showParent() {
                if( !entity.parentid )
                    throw new Exception("No parent document");
                def parent = [:]
                parent.objid = entity.parentid   
                return Inv.lookupOpener( "dts:open", [entity: parent] ); 
            }

        }
    ]]>
    </code>
    
    <pages>
        <page template="tagabukid.dts.DocumentInfoPage"/>
    </pages>
</workunit>